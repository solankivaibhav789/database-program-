DECLARE

VTID NUMBER(3);
VTCID NUMBER(3);

R1 TEST_TAKEN%ROWTYPE;
R2 CANDIDATE%ROWTYPE;
R3 TEST%ROWTYPE;
C NUMBER(5);
CAP TEST_CENTRE.CAPACITY%TYPE;
D DATE;

AVG NUMBER(5,2);

CURSOR C1 IS
SELECT *
FROM TEST_TAKEN;

CURSOR C2 IS 
SELECT *
FROM TEST;

BEGIN

VTID := :TID;
VTCID := :TCID;

SELECT AVG(SCORE) INTO AVG
FROM TEST_TAKEN
WHERE VTID = TID
AND VTCID = TCID;

OPEN C1;
LOOP
FETCH C1 INTO R1;
EXIT WHEN(C1%NOTFOUND);
IF (R1.SCORE >= AVG) THEN 
SELECT * INTO R2
FROM CANDIDATE
WHERE CID = R2.CID;
DBMS_OUTPUT.PUT_LINE ('CID : ' || R2.CID || 'CNAME : ' || C2.CNAME || 'CADDRESS : ' || C2.CADDRESS || 'CBIRTH_DT : ' || R2.CBIRTH_DT);

END IF;
END LOOP;
CLOSE C1;

OPEN C2;
LOOP
FETCH C2 INTO R3;
EXIT WHEN C2%NOTFOUND;
SELECT COUNT(*) INTO C FROM TEST_TAKEN WHERE TID = R3.TID AND TCID = VTCID;
SELECT CAPACITY INTO CAP FROM TEST_CENTRE WHERE TCID = VTCID;

IF( C = CAP ) THEN 
SELECT DISTINCT TEST_DT,TCID INTO D,VTCID  FROM  TEST_TAKEN WHERE TID = R3.TID;
DBMS_OUTPUT.PUT_LINE('TEST CENTRE :' || VTCID || ' HAS FULL ATTENDANCE IN TEST :'||R3.TID|| ' HELD ON DATE: '|| D); 
END IF;
END LOOP;
CLOSE C2;

END;
/